var _ = require('underscore');

var member_role_factory = require('./../resources/models/member_role_model');

function _get_member_tasks(member, cb){
    if (!member.roles){
       return cb(null, []);
    } else {
        var member_roles = member_role_factory();
        member_roles.roles_tasks(member.roles, cb);
    }
}

module.exports = {

    can:function (member, can_tasks, cb) {
        if (!member.tasks) {
            this.member_tasks(function (err, member_tasks) {
                if (err){
                    return cb(err);
                }
                member.tasks = member_tasks;
                var matched_tasks = _.intersection(can_tasks, member.tasks);
                cb(null, (matched_tasks.length == can_tasks.length));
            })
        } else {
            var matched_tasks = _.intersection(can_tasks, member.tasks);
            cb(null, (matched_tasks.length == can_tasks.length));
        }

    },

    member_tasks: function(member, cb){
        var self = this;
        if (member._id){
            _get_member_tasks(member, cb);
        } else {
            this.get(member, function(err, m_record){
                if (err){
                    return cb(err);
                } else {
                    _get_member_tasks(m_record, cb)
                }
            })
        }
    }

}