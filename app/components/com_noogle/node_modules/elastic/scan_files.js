var child_process = require('child_process');
var path = require('path');
var job_pid = null;

var SCAN_DAEMON = path.resolve(__dirname, 'scan_file_daemon');

module.exports = function (callback) {
    if (job_pid) {
        process.kill(job_pid);
    }
    var node_path = process.execPath;

    console.log('exec path (not used) : %s', node_path);

    var scan_job = child_process.spawn('node', [SCAN_DAEMON]);
    job_pid = scan_job.pid;

    callback(null, 'scan job - pid %s', job_pid);

    scan_job.on('exit', function (response) {
        //@TODO - restart.
        console.log("DONE WITH DAEMON RUN")
    })

    var signal_count = 0;
    scan_job.stdout.on('data', function (data) {
        //  var s = 'scan file daemon|data retrive|scanning file'.split('|')[signal_count++]
        //   var regex = new RegExp(s)
        //   t.ok(regex.test(data), 'got expected signal ' + s);

        console.log('FEEDBACK FROM DAEMON: %s', data);
    })

    scan_job.stderr.on('data', function (response) {
        console.log('DAEMON ERROR: %s', '' + response);
    })

}

if (process.argv.length > 2) {
    if (process.argv[2] == 'run') {
        console.log('STARTING SCAN DAEMON')
        module.exports(function (err, result) {
            console.log('FINISHED RUNNING SCAN DAEMON')
        });
    }
}